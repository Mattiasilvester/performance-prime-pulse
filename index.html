<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/jpeg" href="/images/logo-pp-no-bg.jpg" />
    <!-- FIX VIEWPORT PER MOBILE SCROLL -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=auto">
    
    <!-- DISABILITA PWA VIEWPORT COVER -->
    <meta name="apple-mobile-web-app-capable" content="no">
    <meta name="mobile-web-app-capable" content="no">
    
    <!-- NO-CACHE PER MOBILE REFRESH -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Performance Prime - App</title>
    <meta name="description" content="Performance Prime - App fitness per atleti. Traccia allenamenti, monitora progressi, raggiungi obiettivi.">
    <meta property="og:title" content="Performance Prime - Oltre ogni limite">
    <meta property="og:description" content="L'app definitiva per il tuo percorso fitness. Creata da atleti per atleti.">
    <meta property="og:image" content="/images/logo-pp-no-bg.jpg">
    <meta property="og:url" content="https://performanceprime.it">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="keywords" content="fitness, allenamento, palestra, workout, tracking, performance">
    
    <!-- PWA Manifest and Service Worker - RIMOSSO COMPLETAMENTE -->
    
    <!-- CRITICAL MOBILE SCROLL FIX -->
    <style>
      /* Reset mobile viewport restrictions */
      html, body {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        overscroll-behavior-y: auto !important;
        position: relative !important;
        height: auto !important;
        min-height: 100vh !important;
        min-height: -webkit-fill-available !important;
        touch-action: pan-y !important;
      }
      
      #root {
        overflow: visible !important;
        min-height: 100vh !important;
        min-height: -webkit-fill-available !important;
        touch-action: pan-y !important;
      }
      
      /* Override PWA/Lovable mobile restrictions */
      * {
        -webkit-overflow-scrolling: touch !important;
        -ms-overflow-style: auto !important;
        touch-action: auto !important;
      }
      
      /* Fix per iOS Safari */
      @supports (-webkit-touch-callout: none) {
        body {
          position: fixed;
          position: relative !important;
          width: 100%;
        }
      }
      
      /* Previeni position fixed su mobile */
      @media (max-width: 768px) {
        body, html, #root {
          position: relative !important;
          overflow-y: scroll !important;
          -webkit-overflow-scrolling: touch !important;
        }
      }
    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-X8LZRYL596"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      
      gtag('config', 'G-X8LZRYL596');
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <script src="https://tally.so/widgets/embed.js"></script>
    
    <!-- EMERGENCY FIX SCRIPT -->
    <script>
      // Emergency fix per production
      window.addEventListener('load', () => {
        console.log('Emergency fix applied');
        // Fix scroll mobile
        document.body.style.overflow = 'auto';
        // Fix footer color - RIMOSSO per evitare rettangolo nero
        // const footer = document.querySelector('[class*="bottom-0"]');
        // if (footer) footer.style.backgroundColor = 'black';
        // Fix feedback widget position - REMOVED to prevent conflicts
      });
    </script>
    
    <!-- MOBILE SCROLL FIX SCRIPT -->
    <script>
      // Detecta mobile
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      
      // UNREGISTER TUTTI I SERVICE WORKERS
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) {
            registration.unregister();
            console.log('Service worker unregistered');
          }
        });
      }
      
      if (isMobile) {
        // Fix per mobile
        document.addEventListener('DOMContentLoaded', function() {
          // Rimuovi restrizioni touch
          document.body.style.touchAction = 'pan-y';
          document.body.style.webkitOverflowScrolling = 'touch';
          document.body.style.overflowY = 'scroll';
          document.body.style.position = 'relative';
          document.body.style.height = 'auto';
          document.body.style.minHeight = '100vh';
          
          // Fix viewport height per iOS
          const setVH = () => {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
          };
          setVH();
          window.addEventListener('resize', setVH);
          
          // Previeni bounce ma permetti scroll
          document.body.addEventListener('touchmove', function(e) {
            if (e.target === document.body) {
              e.stopPropagation();
            }
          }, { passive: true });
          
          console.log('Mobile scroll fix applied');
        });
        
        // REFRESH DETECTION E FIX
        window.addEventListener('pageshow', function(event) {
          console.log('Page show event:', event.persisted ? 'back/forward cache' : 'normal load');
          
          // Detecta refresh
          if (performance.navigation && performance.navigation.type === 1) {
            console.log('Refresh detected - applying scroll fix');
            
            // Reset completo
            setTimeout(() => {
              document.body.style.cssText = `
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                position: relative !important;
                height: auto !important;
                min-height: 100vh !important;
                touch-action: pan-y !important;
              `;
              
              document.documentElement.style.cssText = `
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
                position: relative !important;
                height: auto !important;
                touch-action: pan-y !important;
              `;
              
              // Trick iOS con scrollTo
              window.scrollTo(0, 1);
              setTimeout(() => {
                window.scrollTo(0, 0);
              }, 10);
              
              console.log('Refresh scroll fix applied');
            }, 100);
          }
        });
        
        // Double-check dopo caricamento
        window.addEventListener('load', function() {
          setTimeout(() => {
            document.body.style.overflow = 'auto';
            document.body.style.overflowY = 'scroll';
            document.body.style.position = 'relative';
            
            // Rimuovi fixed positioning SOLO per elementi non protetti
            // PROTETTI: modal, header, bottom-navigation, notes-header-fixed, feedback-widget, partner-sidebar
            // ESCLUSI: elementi nella dashboard partner (hanno classe partner-dashboard-active sul body)
            const isPartnerDashboard = document.body.classList.contains('partner-dashboard-active');
            if (!isPartnerDashboard) {
              document.querySelectorAll('*').forEach(el => {
                const style = window.getComputedStyle(el);
                const isProtected = el.classList.contains('modal') ||
                                    el.tagName === 'HEADER' ||
                                    el.classList.contains('bottom-navigation') ||
                                    el.classList.contains('notes-header-fixed') ||
                                    el.classList.contains('feedback-widget') ||
                                    el.hasAttribute('data-partner-sidebar') || // Proteggi sidebar partner
                                    el.closest('[class*="partner"]') !== null; // Proteggi elementi partner
                if (style.position === 'fixed' && !isProtected) {
                  el.style.position = 'relative';
                }
              });
            }
          }, 100);
        });
      }
    </script>
  </body>
</html>